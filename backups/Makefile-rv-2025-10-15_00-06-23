include .env
export

DUMP_FILE := $(PGDUMP_DIR)/$(POSTGRES_DB)_$(shell date +%F_%H-%M-%S).dump
BINARY := target/release/$(PROJECT_NAME)

DEPLOY_DIR := $(MAIN_DEPLOY_DIR)/$(PROJECT_NAME)
DEPLOY_BACKUP_DIR := $(DEPLOY_DIR)/backups
REMOTE_DIR := $(MAIN_MEGA_DEPLOY_DIR)/$(PROJECT_NAME)
DATE_TAG := $(shell date +%F_%H-%M-%S)

MEGA_MAKEFILE := $(HOME)/Configs/mega/Makefile

.PHONY: help up down restart backup restore-latest status logs list-dumps dump-path deploy run_d containers sync_db

help h :
	@echo "ğŸ›   Makefile commands:"
	@echo "  make run              â€” Start the Bot with cargo"
	@echo "  make up               â€” Start the PostgreSQL container"
	@echo "  make down             â€” Stop the PostgreSQL container"
	@echo "  make restart          â€” Restart PostgreSQL"
	@echo "  make backup           â€” ğŸ“¦ Create a binary dump into PGDUMP_DIR"
	@echo "  make restore-latest   â€” â™»ï¸  Restore the latest dump"
	@echo "  make status           â€” Check PostgreSQL status (pg_isready)"
	@echo "  make logs             â€” Show container logs"
	@echo "  make list-dumps       â€” List all dumps"
	@echo "  make dump-path        â€” Show current PGDUMP_DIR path"
	@echo "  make deploy           â€” ğŸ”§ Build and deploy binary with backups"
	@echo "  make run_d            â€” ğŸš€ Check containers and run deployed binary"
	@echo "  make containers       â€” ğŸ©º Check health of docker-compose containers"

up :
	docker-compose up -d

down d:
	docker-compose down

restart:
	docker-compose restart postgres

backup:
	@mkdir -p $(PGDUMP_DIR)
	@echo "ğŸ“¦ Creating binary dump â†’ $(DUMP_FILE)"
	docker exec gasbuds-postgres pg_dump -U $(POSTGRES_USER) -Fc $(POSTGRES_DB) > $(DUMP_FILE)
	@echo "âœ… Dump created: $(DUMP_FILE)"
	@echo "ğŸ“ Dump file size:"
	@du -h $(DUMP_FILE)
	@echo "ğŸ“¦ Total dump folder size ($(PGDUMP_DIR)):"
	@du -sh $(PGDUMP_DIR)

restore-latest:
	@LATEST=$$(ls -t $(PGDUMP_DIR)/*.dump 2>/dev/null | head -n1); \
	if [ -z "$$LATEST" ]; then echo "âŒ No .dump files found in $(PGDUMP_DIR)"; exit 1; fi; \
	echo "â™»ï¸  Restoring from: $$LATEST"; \
	cat $$LATEST | docker exec -i gasbuds-postgres pg_restore -U $(POSTGRES_USER) -d $(POSTGRES_DB); \
	echo "âœ… Restore completed."

status:
	@echo "ğŸ” Checking PostgreSQL status..."
	docker exec gasbuds-postgres pg_isready -U $(POSTGRES_USER)
	@echo "-------------------------------------------------------------------------------"
	@echo "ğŸ“¦ Full Mount info for /var/lib/postgresql/data:"
	@docker inspect gasbuds-postgres --format '{{ json .Mounts }}' | jq

logs:
	docker logs -f gasbuds-postgres

list-dumps:
	@echo "ğŸ“‚ Available dumps in: $(PGDUMP_DIR)"
	@ls -lh $(PGDUMP_DIR)/*.dump 2>/dev/null || echo "âŒ No dumps found."

dump-path:
	@echo "ğŸ“ Current dump path: $(PGDUMP_DIR)"

run:
	@echo "ğŸš€ Running gasbuds in release mode..."
	cargo run --release --bin gasbuds

kill:
	sudo lsof -t -i :3031 | xargs -r kill -9

sync_db: #TODO
	@echo "ğŸ”„ Verifying Mega login..."
	@mega-whoami >/dev/null 2>&1 || ( echo "ğŸš« You are not logged in. Run: mega-login"; exit 1 )

	@echo "ğŸ“‚ Local dump path:  $(PGDUMP_DIR)"
	@echo "ğŸŒ Remote path in MEGA: $(MEGA_REMOTE_PATH)"

	@echo "ğŸ” Checking if remote folder exists in MEGA..."
	@mega-ls "$(PGDATA_MEGA_REMOTE_PATH)" >/dev/null 2>&1 || (echo "âŒ Remote folder not found: $(PGDATA_MEGA_REMOTE_PATH)"; exit 1)

	@mega-sync "$(PGDUMP_DIR)" "$(PGDATA_MEGA_REMOTE_PATH)" || (echo "âŒ mega-sync failed"; exit 1 )
	@echo "âœ… Sync successfully configured."

	@echo "ğŸ“‹ Checking current sync connections:"
	@mega-sync | grep "$(PGDUMP_DIR)" || echo "âš ï¸  Sync not listed â€” check manually with: mega-sync"

mkdir:
	@echo "ğŸ“ Initializing PostgreSQL project directories for: $(PROJECT_NAME)"
	mkdir -p $(PGDATA_DIR) $(PGDUMP_DIR)
	ls -la "$(dir $(PGDATA_DIR))"

deploy:
	@echo "ğŸš€ Deploying $(PROJECT_NAME) â†’ $(DEPLOY_DIR)"
	@mkdir -p "$(DEPLOY_DIR)" "$(DEPLOY_BACKUP_DIR)"

	@echo "ğŸ”¨ Building release binary..."
	@cargo build --release && echo "âœ… Build succeeded" || (echo "âŒ Build failed. Aborting deploy."; exit 1)

	@echo "ğŸ“¦ Trying to backup previous version..."
	@if [ -f "$(DEPLOY_DIR)/$(PROJECT_NAME)" ]; then \
		echo "ğŸ—‚  Backup existing binary â†’ backups/"; \
		cp "$(DEPLOY_DIR)/$(PROJECT_NAME)" "$(DEPLOY_BACKUP_DIR)/$(PROJECT_NAME)-rv-$(DATE_TAG)"; \
	fi

	@echo "ğŸ“¦ Copying binary to deploy folder..."
	cp "$(BINARY)" "$(DEPLOY_DIR)/"
	chmod +x "$(DEPLOY_DIR)/$(PROJECT_NAME)"

	@echo "ğŸ“ Copying .env (with backup)..."
	@if [ -f "$(DEPLOY_DIR)/.env" ]; then \
		echo "ğŸ—‚  Backup existing .env â†’ backups/"; \
		cp "$(DEPLOY_DIR)/.env" "$(DEPLOY_BACKUP_DIR)/.env-rv-$(DATE_TAG)"; \
	fi
	cp .env "$(DEPLOY_DIR)/.env"

	@echo "ğŸ“ Copying .gitignore (no backup)..."
	cp .gitignore "$(DEPLOY_DIR)/.gitignore" || true

	@echo "ğŸ“ Copying Makefile (with backup)..."
	@if [ -f "$(DEPLOY_DIR)/Makefile" ]; then \
		echo "ğŸ—‚  Backup existing Makefile â†’ backups/"; \
		cp "$(DEPLOY_DIR)/Makefile" "$(DEPLOY_BACKUP_DIR)/Makefile-rv-$(DATE_TAG)"; \
	fi
	cp Makefile "$(DEPLOY_DIR)/Makefile"

	@echo "ğŸ“ Copying Scripts/ directory..."
	@if [ -d Scripts ]; then \
		mkdir -p "$(DEPLOY_DIR)/Scripts"; \
		cp -R Scripts/. "$(DEPLOY_DIR)/Scripts/"; \
		echo "âœ… Scripts copied"; \
	else \
		echo "â„¹ï¸  No Scripts/ directory found, skipping"; \
	fi

	@echo "âœ… Deploy complete!"

containers:
	@echo "ğŸ” Checking docker-compose containers..."
	@containers=$$(docker-compose ps -q); \
	if [ -z "$$containers" ]; then \
		echo "âš ï¸  No containers found via docker-compose."; \
		exit 1; \
	fi; \
	echo "ğŸ“‹ Container statuses:"; \
	all_statuses=$$(docker inspect --format '{{.Name}} | State: {{.State.Status}} | Health: {{if .State.Health}}{{.State.Health.Status}}{{else}}(no healthcheck){{end}}' $$containers); \
	echo "$$all_statuses"; \
	not_running=$$(echo "$$all_statuses" | grep -v 'State: running' | grep -v 'Health: healthy'); \
	if [ -n "$$not_running" ]; then \
		echo "âŒ Some containers are NOT healthy or running:"; \
		echo "$$not_running"; \
		exit 1; \
	else \
		echo "âœ… All containers are running and healthy."; \
	fi

run_d:
	@echo "ğŸ” Starting deploy-run sequence..."
	@echo "ğŸš€ Running deployed binary from $(DEPLOY_DIR)..."
	@$(DEPLOY_DIR)/$(PROJECT_NAME)

sync-deploy sd:
	@echo "ğŸ” Syncing deploy directory: $(DEPLOY_DIR) to remote MEGA directory: $(REMOTE_DIR) ..."
	@make -f $(MEGA_MAKEFILE) sync $(DEPLOY_DIR) $(REMOTE_DIR)
